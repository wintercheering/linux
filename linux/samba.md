# 配置 samba 服务器

 <p><span>以前我们在</span><span>windows</span><span>上共享文件的话，只需右击要共享的文件夹然后选择共享相关的选项设置即可。然而如何实现</span><span>windows</span><span>和</span><span>linux</span><span>的文件共享呢？这就涉及到了</span><span>samba</span><span>服务了，这个软件配置起来也不难，使用也非常简单。</span></p> <p><span></span></p><p> </p> <p><span>【</span><b><span>samba</span></b><b><span>配置文件</span><span>smb.conf</span></b><span>】</span></p> <p><span>一般你装系统的时候会默认安装</span><span>samba</span><span>，如果没有安装，只需要运行这个命令安装</span><span>(CentOS)</span><span>：</span><span></span></p> <p><span>“yum install -y samba samba-client”</span></p> <p><span>Samba</span><span>的配置文件为</span><span>/etc/samba/smb.conf</span><span>，通过修改这个配置文件来完成我们的各种需求。打开这个配置文件，你会发现很多内容都用</span><span>”#”</span><span>或者</span><span>”;”</span><span>注视掉了。先看一下未被注释掉的部分：</span><span></span></p> <p><span>[global]</span></p> <p><span><span>        </span>workgroup = MYGROUP</span></p> <p><span><span>        </span>server string = Samba Server Version %v</span></p> <p><span><span>        </span>security = user</span></p> <p><span><span>        </span>passdb backend = tdbsam</span></p> <p><span><span>        </span>load printers = yes</span></p> <p><span><span>        </span>cups options = raw</span></p> <p><span>[homes]</span></p> <p><span><span>        </span>comment = Home Directories</span></p> <p><span><span>        </span>browseable = no</span></p> <p><span><span>        </span>writable = yes</span></p> <p><span>[printers]</span></p> <p><span><span>        </span>comment = All Printers</span></p> <p><span><span>    </span><span>    </span>path = /var/spool/samba</span></p> <p><span><span>        </span>browseable = no</span></p> <p><span><span>        </span>guest ok = no</span></p> <p><span><span>        </span>writable = no</span></p> <p><span><span>        </span>printable = yes</span></p> <p><span>主要有以上三个部分：</span><span>[global], [homes], [printers]</span><span>。</span><span></span></p> <p><b><span></span></b></p><p><b> </b></p><b></b> <p><b><span>[global]</span></b><span>定义全局的配置，</span><span>”workgroup”</span><span>用来定义工作组，相信如果你安装过</span><span>windows</span><span>的系统，你会对这个</span><span>workgroup</span><span>不陌生。一般情况下，需要我们把这里的</span><span>”MYGROUP”</span><span>改成</span><span>”WORKGROUP”</span><span>（</span><span>windows</span><span>默认的工作组名字）。</span><span></span></p> <p><span>security = user #</span><span>这里指定</span><span>samba</span><span>的安全等级。关于安全等级有四种：</span><span></span></p> <p><span>share</span><span>：用户不需要账户及密码即可登录</span><span>samba</span><span>服务器</span><span></span></p> <p><span>user</span><span>：由提供服务的</span><span>samba</span><span>服务器负责检查账户及密码（默认）</span><span></span></p> <p><span>server</span><span>：检查账户及密码的工作由另一台</span><span>windows</span><span>或</span><span>samba</span><span>服务器负责</span><span></span></p> <p><span>domain</span><span>：指定</span><span>windows</span><span>域控制服务器来验证用户的账户及密码。</span><span></span></p> <p><span>passdb backend = tdbsam<span>  </span># passdb backend </span><span>（用户后台），</span><span>samba</span><span>有三种用户后台：</span><span>smbpasswd, tdbsam</span><span>和</span><span>ldapsam.</span></p> <p><span>smbpasswd</span><span>：该方式是使用</span><span>smb</span><span>工具</span><span>smbpasswd</span><span>给系统用户（真实用户或者虚拟用户）设置一个</span><span>Samba </span><span>密码，客户端就用此密码访问</span><span>Samba</span><span>资源。</span><span>smbpasswd</span><span>在</span><span>/etc/samba</span><span>中，有时需要手工创建该文件。</span><span></span></p> <p><span>tdbsam</span><span>：使用数据库文件创建用户数据库。数据库文件叫</span><span>passdb.tdb</span><span>，在</span><span>/etc/samba</span><span>中。</span><span>passdb.tdb</span><span>用户数据库可使用</span><span>smbpasswd </span><span>–</span><span>a</span><span>创建</span><span>Samba</span><span>用户，要创建的</span><span>Samba</span><span>用户必须先是系统用户。也可使用</span><span>pdbedit</span><span>创建</span><span>Samba</span><span>账户。</span><span>pdbedit</span><span>参数很多，列出几个主要的：</span><span></span></p> <p><span>pdbedit </span><span>–</span><span>a username</span><span>：新建</span><span>Samba</span><span>账户。</span><span></span></p> <p><span>pdbedit </span><span>–</span><span>x username</span><span>：删除</span><span>Samba</span><span>账户。</span><span></span></p> <p><span>pdbedit </span><span>–</span><span>L</span><span>：列出</span><span>Samba</span><span>用户列表，读取</span><span>passdb.tdb</span><span>数据库文件。</span><span></span></p> <p><span>pdbedit </span><span>–</span><span>Lv</span><span>：列出</span><span>Samba</span><span>用户列表详细信息。</span><span></span></p> <p><span>pdbedit </span><span>–</span><span>c </span><span>“</span><span>[D]</span><span>”</span><span>–</span><span>u username</span><span>：暂停该</span><span>Samba</span><span>用户账号。</span><span></span></p> <p><span>pdbedit </span><span>–</span><span>c </span><span>“</span><span>[]</span><span>”</span><span>–</span><span>u username</span><span>：恢复该</span><span>Samba</span><span>用户账号。</span><span></span></p> <p><span>ldapsam</span><span>：基于</span><span>LDAP</span><span>账户管理方式验证用户。首先要建立</span><span>LDAP</span><span>服务，设置“</span><span>passdb backend = ldapsam:ldap://LDAP Server</span><span>”</span><span></span></p> <p><span>load printers </span><span>和</span><span> cups options </span><span>两个参数用来设置打印机相关。</span><span></span></p> <p><span>除了这些参数外，还有几个参数需要你了解：</span><span></span></p> <p><span>netbios name = MYSERVER<span>  </span># </span><span>设置出现在“网上邻居”中的主机名</span><span></span></p> <p><span>hosts allow = 127. <span> </span>192.168.12. <span> </span>192.168.13. # </span><span>用来设置允许的主机，如果在前面加</span><span>”;”</span><span>则表示允许所有主机</span><span></span></p> <p><span>log file = /var/log/samba/%m.log #</span><span>定义</span><span>samba</span><span>的日志，这里的</span><span>%m</span><span>是上面的</span><span>netbios name</span></p> <p><span>max log size = 50 # </span><span>指定日志的最大容量，单位是</span><span>K</span></p> <p><b><span></span></b></p><p><b> </b></p><b></b> <p><b><span>[homes]</span></b><span>该部分内容共享用户自己的家目录，也就是说，当用户登录到</span><span>samba</span><span>服务器上时实际上是进入到了该用户的家目录，用户登陆后，共享名不是</span><span>homes</span><span>而是用户自己的标识符，对于单纯的文件共享的环境来说，这部分可以注视掉。</span><span></span></p> <p><b><span></span></b></p><p><b> </b></p><b></b> <p><b><span>[printers]</span></b><span>该部分内容设置打印机共享。</span><span></span></p> <p><span></span></p><p> </p> <p><span>【</span><b><span>samba</span></b><b><span>实践</span></b><span>】</span><span></span></p> <p><span>注意：在试验之前，请先检测</span><span>selinux</span><span>是否关闭，否则可能会试验不成功。关于如何关闭</span><span>selinux</span><span>请查看</span><span><a><span><span>第十五章</span></span> linux<span><span>系统日常管理</span></span></a></span><span>的“</span><span>linux</span><span>的防火墙</span><span>”部分</span><span></span></p> <p><span></span></p><p> </p> <p><b><span>1. </span></b><b><span>共享一个目录，任何人都可以访问，即不用输入密码即可访问，要求只读。</span></b><b><span></span></b></p><p><b></b></p><b></b> <p><span>打开</span><span>samba</span><span>的配置文件</span><span>/etc/samba/smb.conf </span></p> <p><span>[global]</span><span>部分</span><span></span></p> <p><span>把</span><span>”MY GROUP”</span><span>改成</span><span>”WORKGROUP”</span></p> <p><span>把</span><span>”</span><span>security = user” </span><span>修改为</span><span> <span>“security = share”</span></span></p> <p><span>然后在文件的最末尾处加入以下内容：</span><span></span></p> <p><span>[share]</span></p> <p><span><span>        </span>comment = share all</span></p> <p><span><span>        </span>path = /tmp/samba</span></p> <p><span><span>        </span>browseable = yes</span></p> <p><span><span>        </span>public = yes</span></p> <p><span><span>        </span>writable = no</span></p> <p><span></span></p><p> </p> <p><span>mkdir /tmp/samba</span></p> <p><span>chmod 777 /tmp/samba</span></p> <p><span>启动</span><span>samba</span><span>服务</span><span></span></p> <p><span>/etc/init.d/smb start</span></p> <p><span></span></p><p> </p> <p><span>测试：</span><span></span></p> <p><span>首先测试你配置的</span><span>smb.conf</span><span>是否正确，用下面的命令</span><span></span></p> <p><span>testparm</span></p> <p><span>如果没有错误，则在你的</span><span>windows</span><span>机器上的浏览器中输入</span><span> <span>file://IP/share </span></span><span>看是否能访问</span><span></span></p> <p><span></span></p><p> </p> <p><b><span>2. </span></b><b><span>共享一个目录，使用用户名和密码登录后才可以访问，要求可以读写</span></b><b><span></span></b></p><p><b></b></p><b></b> <p><span>打开</span><span>samba</span><span>的配置文件</span><span>/etc/samba/smb.conf </span></p> <p><span>[global] </span><span>部分内容如下：</span><span></span></p> <p><span>[global]</span></p> <p><span><span>        </span>workgroup = WORKGROUP</span></p> <p><span><span>        </span>server string = Samba Server Version %v</span></p> <p><span><span>        </span>security = user</span></p> <p><span><span>        </span>passdb backend = tdbsam</span></p> <p><span><span>        </span>load printers = yes</span></p> <p><span><span>        </span>cups options = raw</span></p> <p><span></span></p><p> </p> <p><span>然后加入以下内容：</span><span></span></p> <p><span>[myshare]</span></p> <p><span><span>        </span>comment = share for users</span></p> <p><span><span>        </span>path = /samba</span></p> <p><span><span>        </span>browseable = yes</span></p> <p><span><span>        </span>writable = yes</span></p> <p><span><span>        </span>public = no</span></p> <p><span></span></p><p> </p> <p><span>保存配置文件，创建目录：</span><span></span></p> <p><span>mkdir /samba</span></p> <p><span>chmod 777 /samba</span></p> <p><span>然后添加用户。因为在</span><span>[globa]</span><span>中</span><span>” passdb backend = tdbsam”</span><span>，所以要使用</span><span>” pdbedit” </span><span>来增加用户，注意添加的用户必须在系统中存在。</span><span></span></p> <p><span>useradd<span>  </span>user1 user2</span></p> <p><span>pdbedit -a user1<span>  </span># </span><span>添加</span><span>user1</span><span>账号，并定义其密码</span><span></span></p> <p><span>pdbedit -a user2</span></p> <p><span>pdbedit -L # </span><span>列出所有的账号</span><span></span></p> <p><span>测试：</span><span></span></p> <p><span>打开</span><span>IE</span><span>浏览器输入</span><span>file://IP/myshare/ </span><span>然后输入用户名和密码</span><span></span></p> <p><span></span></p><p> </p> <p><b><span>3. </span></b><b><span>使用</span></b><b><span>linux</span></b><b><span>访问</span></b><b><span>samba</span></b><b><span>服务器</span></b><b><span></span></b></p><p><b></b></p><b></b> <p><span>Samba</span><span>服务在</span><span>linux</span><span>下同样可以访问。前提是你的</span><span>linux</span><span>安装了</span><span>samba-client</span><span>软件包。安装完后就可以使用</span><span>smbclient</span><span>命令了。</span><span></span></p> <p><span>smbclient //IP/</span><span>共享名</span><span><span>  </span>-U </span><span>用户名</span><span><span>  </span></span></p> <p><span>如：</span><span>[root@localhost]# <b>smbclient //10.0.4.67/myshare/ -U user1</b></span></p> <p><span>Password:</span></p> <p><span>Domain=[LOCALHOST] OS=[Unix] Server=[Samba 3.0.33-3.29.el5_6.2]</span></p> <p><span>smb: \&gt;</span></p> <p><span>出现如上所示的界面。可以打一个</span><span>”?”</span><span>列出所有可以使用的命令。常用的有</span><span>cd, ls, rm, pwd, tar, mkdir, chown, get, put</span><span>等等，使用</span><span>help + </span><span>命令可以打印该命令如何使用，其中</span><span>get</span><span>是下载，</span><span>put</span><span>是上传。</span><span></span></p> <p><span>另外的方式就是通过</span><span>mount</span><span>挂载了：</span><span></span></p> <p><span>如：</span><span></span></p> <p><b><span>mount -t cifs //10.0.4.67/myshare /mnt -o username=user1,password=123456</span></b></p><p><b></b></p><b></b> <p><span>格式就是这样，要指定</span><span>-t cifs //IP/</span><span>共享名</span><span>本地挂载点</span><span><span>  </span>-o</span><span>后面跟</span><span>username </span><span>和</span><span> password</span></p> <p><span>挂载完后就可以像使用本地的目录一样使用共享的目录了。</span><span></span></p> <p><span></span></p><p> </p> </div>  </div>
