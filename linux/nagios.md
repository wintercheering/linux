# 使用 Nagios 搭建监控服务器

<p><span>【<b>关于</b></span><b><span>Nagios</span></b><span>】</span><span></span></p> <p><span>Nagios</span><span>是一款用于监控系统和网络的开源应用软件，它的模式是服务器</span><span>—</span><span>客户端，也就是说首先要在在一台服务器上（</span><span>server</span><span>）部署相应的主要套件，然后在要监控的服务器上部署客户端程序，这样</span><span>server</span><span>会和</span><span>client</span><span>通信，从而监控</span><span>client</span><span>端的各项资源。</span><span>Nagios</span><span>功能十分强大几乎所有的项目都可以监控，大到服务器的存活状态，小到服务器上的某一个服务（</span><span>web</span><span>）。这些功能都是通过自定义插件（或者叫做脚本）来实现。</span><span></span></p> <p><span>当</span><span>Nagios</span><span>监控到某项资源发生异常会通知到用户，你可以接入手机短信接口也可以接入邮件接口。我们可以通过</span><span>web</span><span>页面来查看</span><span>Nagios</span><span>所监控的各项资源，默认搭建的</span><span>Nagios</span><span>服务器只能监控简单的几个项目，而其他服务之类的监控项目都是由我们自己开发的插件来实现的。</span><span></span></p> <p><span></span></p><p> </p> <p><span>【<b>需要下载的软件</b>】</span><span></span></p> <p><span>nagios-3.0.5 <span> </span></span></p> <p><span>nagios-plugins-1.4.13 <span> </span></span></p> <p><span>nrpe-2.12.tar.gz </span></p> <p><span>apache-2.2.11<span>  </span><span> </span></span></p> <p><span>// </span><span>以上软件版本可以不一样</span><span></span></p> <p><span></span></p><p> </p> <p><span>【<b>监控中心</b></span><b><span>Server</span></b><b><span>端的配置</span></b><span>】</span><span></span></p> <p><span>1. </span><span>安装</span><span>apache </span><span>（略，请参考第</span><span>16</span><span>章中相关内容，只需安装，到后边再配置）</span><span></span></p> <p><span></span></p><p> </p> <p><span>2. </span><span>建立</span><span>nagios</span><span>账户</span><span></span></p> <p><i><span>useradd<span>  </span>nagios</span></i></p><p><i></i></p><i></i> <p><span></span></p><p> </p> <p><span>3. </span><span>下载软件</span><span></span></p> <p><i><span>cd<span>  </span>/usr/local/src/</span></i></p><p><i></i></p><i></i> <p><i><span>wget<span>  </span>http://syslab.comsenz.com/downloads/linux/nagios-3.0.5.tar.gz</span></i></p><p><i></i></p><i></i> <p><i><span>wget<span>  </span>http://syslab.comsenz.com/downloads/linux/nagios-plugins-1.4.13.tar.gz</span></i></p><p><i></i></p><i></i> <p><i><span>wget <span> </span>http://syslab.comsenz.com/downloads/linux/nrpe-2.12.tar.gz</span></i></p><p><i></i></p><i></i> <p><span></span></p><p> </p> <p><span>4. </span><span>编译安装</span><span>nagios</span></p> <p><i><span>cd<span>  </span>/usr/local/src/</span></i></p><p><i></i></p><i></i> <p><i><span>tar<span>  </span>zxvf<span>  </span>nagios-3.0.5.tar.gz</span></i></p><p><i></i></p><i></i> <p><i><span>cd<span>  </span>nagios-3.0.5</span></i></p><p><i></i></p><i></i> <p><i><span>./configure<span>  </span>--prefix=/usr/local/nagios</span></i></p><p><i></i></p><i></i> <p><i><span>make all</span></i></p><p><i></i></p><i></i> <p><i><span>make install</span></i></p><p><i></i></p><i></i> <p><i><span>make install-init </span></i><span><span> </span># </span><span>把</span><span>nagios</span><span>做成一个运行脚本，使</span><span>nagios</span><span>随系统开机启动</span><span></span></p> <p><i><span>make install-config<span>  </span># </span></i><span>把配置文件样例复制到</span><span>nagios</span><span>的安装目录</span><span></span></p> <p><i><span>make install-commandmode # </span></i><span>给外部命令访问</span><span>nagios</span><span>配置文件的权限</span><span></span></p> <p><i><span>chown -R nagios:nagios /usr/local/nagios</span></i></p><p><i></i></p><i></i> <p><span></span></p><p> </p> <p><span>5. </span><span>编译安装</span><span>nagios-plugins</span></p> <p><i><span>cd<span>  </span>/usr/local/src/</span></i></p><p><i></i></p><i></i> <p><i><span>tar zxvf nagios-plugins-1.4.13.tar.gz</span></i></p><p><i></i></p><i></i> <p><i><span>cd<span>  </span>nagios-plugins-1.4.13</span></i></p><p><i></i></p><i></i> <p><i><span>./configure<span>  </span>--prefix=/usr/local/nagios --with-nagios-user=nagios --with-nagios-group=nagios</span></i></p><p><i></i></p><i></i> <p><i><span>make &amp;&amp; make install</span></i></p><p><i></i></p><i></i> <p><span>查看是否安装成功的方法是：</span><span></span></p> <p><i><span>ls /usr/local/nagios/libexec/</span></i></p><p><i></i></p><i></i> <p><span>看这个目录下是否有插件文件</span><span></span></p> <p><span></span></p><p> </p> <p><span>6. </span><span>安装</span><span>nrpe</span></p> <p><i><span>cd /usr/local/src/</span></i></p><p><i></i></p><i></i> <p><i><span>tar zxvf<span>  </span></span></i><span>nrpe-2.12.tar.gz </span></p> <p><i><span>cd nrpe-2.12</span></i></p><p><i></i></p><i></i> <p><i><span>./configure --enable-ssl --enable-command-args</span></i></p><p><i></i></p><i></i> <p><i><span>make all</span></i></p><p><i></i></p><i></i> <p><i><span>make install-plugin</span></i></p><p><i></i></p><i></i> <p><i><span>make install-daemon</span></i></p><p><i></i></p><i></i> <p><i><span>make install-daemon-config</span></i></p><p><i></i></p><i></i> <p><span></span></p><p> </p> <p><span>7. </span><span>配置</span><span>web</span><span>接口</span><span></span></p> <p><i><span>vim<span>  </span>/usr/local/apache2/conf/httpd.conf</span></i></p><p><i></i></p><i></i> <p><span>在最后加入以下内容：</span><span></span></p> <p><span>ScriptAlias /nagios/cgi-bin /usr/local/nagios/sbin </span></p> <p><span>&lt;Directory "/usr/local/nagios/sbin/"&gt;</span></p> <p><span><span>     </span>AllowOverride AuthConfig</span></p> <p><span><span>     </span>Options ExecCGI</span></p> <p><span><span>     </span>Order allow,deny</span></p> <p><span><span>     </span>Allow from all</span></p> <p><span>&lt;/Directory&gt;</span></p> <p><span><span>  </span>Alias /nagios/ /usr/local/nagios/share/</span></p> <p><span>&lt;Directory "/usr/local/nagios/share"&gt;</span></p> <p><span><span>     </span>Options None</span></p> <p><span><span>     </span>AllowOverride AuthConfig</span></p> <p><span><span>     </span>Order allow,deny</span></p> <p><span><span>     </span>Allow from all</span></p> <p><span>&lt;/Directory&gt;</span></p> <p><span></span></p><p> </p> <p><span>8. </span><span>配置</span><span>nagios</span></p> <p><i><span>cd<span>  </span>/usr/local/nagios/etc/</span></i></p><p><i></i></p><i></i> <p><i><span>vim cgi.cfg</span></i></p><p><i></i></p><i></i> <p><span>把</span><span> <span>use_authentication=1<span>  </span></span></span><span>改成</span><span><span>  </span>use_authentication=0<span>  </span></span><span>意思是不用用户验证</span><span></span></p> <p><span></span></p><p> </p> <p><span>9. </span><span>启动</span><span>nagios </span></p> <p><span>在启动前先检测一下：</span><span></span></p> <p><i><span>/usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</span></i></p><p><i></i></p><i></i> <p><span>如果最后显示如下，则说明配置没有问题了。</span><span></span></p> <p><span>Total Warnings: 0</span></p> <p><span>Total Errors:<span>   </span>0</span></p> <p><span>启动命令：</span><span></span></p> <p><i><span>/etc/init.d/nagios start</span></i></p><p><i></i></p><i></i> <p><span>或者：</span><span></span></p> <p><i><span>/usr/local/nagios/bin/nagios -d /usr/local/nagios/etc/nagios.cfg</span></i></p><p><i></i></p><i></i> <p><span></span></p><p> </p> <p><span>此时，就可以访问</span><span>web</span><span>页面的</span><span>nagios</span><span>了，在浏览器中输入：</span><span></span></p> <p><span>http://IP/nagios/ </span><span>看看吧。</span><span></span></p> <p><span></span></p><p> </p> <p><span>【<b>在要监控的机器上</b></span><b><span>client</span></b><b><span>部署</span></b><b><span>nagios</span></b><span>】</span><b><span></span></b></p><p><b></b></p><b></b> <p><span>如果你打开了</span><span>web</span><span>页面，点击左栏的</span><span>Host Detail </span><span>会在右栏看到一行数据，其中</span><span>Host </span><span>名为</span><span> <span>“localhost” </span></span><span>，</span><span>Status</span><span>显示为</span><span>”up”</span><span>，并且显示为绿色，如果是其他颜色就说明你的</span><span>localhost</span><span>出了问题。目前只有一行数据，也就是说只监控了监控中心（</span><span>localhost</span><span>）一台主机，那么如何添加其他机器被它监控呢？这就需要在要被监控的机器上也部署</span><span>nagios</span><span>软件。</span><span></span></p> <p><span>1. </span><span>添加账户</span><span></span></p> <p><i><span>useradd nagios</span></i></p><p><i></i></p><i></i> <p><span></span></p><p> </p> <p><span>2. </span><span>安装</span><span>nrpe</span></p> <p><i><span>cd /usr/local/src/</span></i></p><p><i></i></p><i></i> <p><i><span>wget<span>  </span>http://syslab.comsenz.com/downloads/linux/nrpe-2.12.tar.gz</span></i></p><p><i></i></p><i></i> <p><i><span>tar zxvf<span>  </span></span></i><span>nrpe-2.12.tar.gz </span></p> <p><i><span>cd nrpe-2.12</span></i></p><p><i></i></p><i></i> <p><i><span>./configure --enable-ssl --enable-command-args</span></i></p><p><i></i></p><i></i> <p><i><span>make all</span></i></p><p><i></i></p><i></i> <p><i><span>make install-plugin</span></i></p><p><i></i></p><i></i> <p><i><span>make install-daemon</span></i></p><p><i></i></p><i></i> <p><i><span>make install-daemon-config</span></i></p><p><i></i></p><i></i> <p><span></span></p><p> </p> <p><span>3. </span><span>安装</span><span>nagios-plugin</span></p> <p><i><span>cd<span>  </span>/usr/local/src/</span></i></p><p><i></i></p><i></i> <p><i><span>wget http://syslab.comsenz.com/downloads/linux/nagios-plugins-1.4.13.tar.gz</span></i></p><p><i></i></p><i></i> <p><i><span>tar zxvf nagios-plugins-1.4.13.tar.gz</span></i></p><p><i></i></p><i></i> <p><i><span>cd<span>  </span>nagios-plugins-1.4.13</span></i></p><p><i></i></p><i></i> <p><i><span>./configure<span>  </span>--prefix=/usr/local/nagios --with-nagios-user=nagios --with-nagios-group=nagios</span></i></p><p><i></i></p><i></i> <p><i><span>make &amp;&amp; make install</span></i></p><p><i></i></p><i></i> <p><span>到此就算安装完成了，请查看</span><span>/usr/local/nagios/</span><span>目录下是否有四个目录分别为：</span><span>bin<span>  </span>etc<span>  </span>libexec<span>  </span>share </span><span>另外在</span><span>libexec</span><span>目录下会有很多</span><span>check_</span><span>开头的文件。如果你的机器上没有，就请重新安装吧。</span><span></span></p> <p><span></span></p><p> </p> <p><span>4. </span><span>配置</span><span></span></p> <p><i><span>vim /usr/local/nagios/etc/nrpe.cfg</span></i></p><p><i></i></p><i></i> <p><span>找到</span><span>”allowed_hosts=127.0.0.1” </span><span>改成</span><span> <span>“allowed_hosts=127.0.0.1,10.0.4.67” </span></span></p> <p><span>// </span><span>后边的</span><span>IP</span><span>是</span><span>server</span><span>的</span><span>IP</span></p> <p><span>找到</span><span>”</span><span>dont_blame_nrpe=0” </span><span>改成</span><span> <span>“dont_blame_nrpe=1”</span></span></p> <p><span></span></p><p> </p> <p><span>5. </span><span>启动</span><span>nrpe</span></p> <p><i><span>/usr/local/nagios/bin/nrpe -c /usr/local/nagios/etc/nrpe.cfg -d</span></i></p><p><i></i></p><i></i> <p><span></span></p><p> </p> <p><span>【<b>在监控中心添加被监控主机</b>】</span><span></span></p> <p><span>添加主机当然是要到</span><span>server</span><span>端（监控中心）修改配置文件了。</span><span></span></p> <p><span>1. </span><span>修改主配置文件</span><span></span></p> <p><i><span>cd<span>  </span>/usr/local/nagios/etc/</span></i></p><p><i></i></p><i></i> <p><i><span>vim nagios.cfg</span></i></p><p><i></i></p><i></i> <p><span>增加内容：</span><span></span></p> <p><span>cfg_dir=/usr/local/nagios/etc/services<span>   </span>##</span><span>定义一个目录，以后把新增加的主机信息文件全部放到这里</span><span></span></p> <p><span></span></p><p> </p> <p><span>2. </span><span>添加被监控主机信息</span><span></span></p> <p><i><span>mkdir /usr/local/nagios/etc/services</span></i></p><p><i></i></p><i></i> <p><i><span>cd<span>  </span>/usr/local/nagios/etc/services</span></i></p><p><i></i></p><i></i> <p><i><span>vim<span>  </span>10.0.4.56.cfg </span></i><span><span> </span></span><span>加入如下内容：</span><span></span></p> <p><span>define host{</span></p> <p><span><span>        </span>use<span>     </span>linux-server</span></p> <p><span><span>        </span>host_name<span>       </span>10.0.4.56</span></p> <p><span><span>        </span>alias<span>           </span>10.0.4.56</span></p> <p><span><span>        </span>address<span>         </span>10.0.4.56</span></p> <p><span>}</span></p> <p><span>define service{</span></p> <p><span><span>        </span>use<span>     </span>generic-service</span></p> <p><span><span>        </span>host_name<span>       </span>10.0.4.56</span></p> <p><span><span>        </span>service_description<span>     </span>check_ping</span></p> <p><span><span>        </span>check_command<span>           </span>check_ping!100.0,20%!200.0,50%</span></p> <p><span><span>        </span>max_check_attempts 5</span></p> <p><span><span>        </span>normal_check_interval 1</span></p> <p><span>}</span></p> <p><span>define service{</span></p> <p><span><span> </span><span>       </span>use<span>     </span>generic-service</span></p> <p><span><span>        </span>host_name<span>       </span>10.0.4.56</span></p> <p><span><span>        </span>service_description<span>     </span>check_ssh</span></p> <p><span><span>        </span>check_command<span>           </span>check_ssh</span></p> <p><span><span>        </span>max_check_attempts 5</span></p> <p><span><span>        </span>normal_check_interval 1</span></p> <p><span>}</span></p> <p><span>define service{</span></p> <p><span><span>        </span>use<span>     </span>generic-service</span></p> <p><span><span>        </span>host_name<span>       </span>10.0.4.56</span></p> <p><span><span>        </span>service_description<span>     </span>check_http</span></p> <p><span><span>        </span>check_command<span>           </span>check_http</span></p> <p><span><span>        </span>max_check_attempts 5</span></p> <p><span><span>        </span>normal_check_interval 1</span></p> <p><span>}</span></p> <p><span>// </span><span>注意，这里的</span><span>IP</span><span>是</span><span>client</span><span>端的</span><span>IP</span><span>，监控的项目有三个</span><span>ping, ssh, http</span><span>。其实这三个项目使用的脚本都为本地脚本，也就是说，即使远程主机没有安装</span><span>nagios</span><span>和</span><span>nrpe</span><span>同样可以监控这些项目。但是如果想监控</span><span>load</span><span>，</span><span>disk</span><span>，等等就需要通过</span><span>nrpe</span><span>服务来搞定了，道理很简单，</span><span>load</span><span>和</span><span>disk</span><span>都需要登录到远程主机上去获得信息，而</span><span>ping</span><span>，</span><span>ssh</span><span>，</span><span>http</span><span>都不需要的。这个到远程主机获取相关的信息的过程是由</span><span>nrpe</span><span>完成的。如果你的</span><span>client</span><span>上没有启动</span><span>nrpe</span><span>服务那么我们是无法获取远程主机的</span><span>load</span><span>和</span><span>disk</span><span>等信息的。下面笔者配置一下使用</span><span>nrpe</span><span>来监控远程主机的相关项目。</span><span></span></p> <p><span>在</span><span>server</span><span>端编辑</span><span>/usr/local/nagios/etc/objects/commands.cfg</span></p> <p><i><span>vim<span>  </span>/usr/local/nagios/etc/objects/commands.cfg<span>  </span></span></i><span># </span><span>在最后面添加如下内容</span><span></span></p> <p><span>define command{</span></p> <p><span><span>        </span>command_name<span>    </span>check_nrpe</span></p> <p><span><span>        </span>command_line<span>    </span>$USER1$/check_nrpe -H $HOSTADDRESS$ -c $ARG1$</span></p> <p><span><span>        </span>}</span></p> <p><span>然后编辑</span><span>10.0.4.56.cfg </span><span>（还是</span><span>server</span><span>上）</span><span></span></p> <p><i><span>cd<span>   </span>/usr/local/nagios/etc/services</span></i></p><p><i></i></p><i></i> <p><i><span>vim<span>  </span>10.0.4.56.cfg<span>   </span></span></i><span># </span><span>加入如下内容：</span><span></span></p> <p><span>define service{</span></p> <p><span><span>        </span>use<span>     </span>generic-service</span></p> <p><span><span>        </span>host_name<span>       </span>10.0.4.56</span></p> <p><span><span>        </span>service_description<span>     </span>check_load</span></p> <p><span><span>        </span>check_command<span>           </span>check_nrpe!check_load</span></p> <p><span><span>        </span>max_check_attempts 5</span></p> <p><span><span>        </span>normal_check_interval 1</span></p> <p><span>}</span></p> <p><span></span></p><p> </p> <p><span>define service{</span></p> <p><span><span>        </span>use<span>     </span>generic-service</span></p> <p><span><span>        </span>host_name<span>       </span>10.0.4.56</span></p> <p><span><span>        </span>service_description<span>     </span>check_disk_hda1</span></p> <p><span><span>        </span>check_command<span>           </span>check_nrpe!check_hda1</span></p> <p><span><span>        </span>max_check_attempts 5</span></p> <p><span><span>        </span>normal_check_interval 1</span></p> <p><span>}</span></p> <p><span></span></p><p> </p> <p><span>define service{</span></p> <p><span><span>        </span>use<span>     </span>generic-service</span></p> <p><span><span>        </span>host_name<span>       </span>10.0.4.56</span></p> <p><span><span>        </span>service_description<span>     </span>check_disk_hda2</span></p> <p><span><span>        </span>check_command<span>           </span>check_nrpe!check_hda2</span></p> <p><span><span>        </span>max_check_attempts 5</span></p> <p><span><span>        </span>normal_check_interval 1</span></p> <p><span>}</span></p> <p><span>// </span><span>这里需要解释一下相关的</span><span>”check_command”, </span><span>先看这个</span><span>” check_nrpe!check_load” </span><span>这里的</span><span>check_nrpe</span><span>就是上面</span><i><span>/usr/local/nagios/etc/objects/commands.cfg</span></i><span>中刚刚定义的，后面的</span><span>check_load</span><span>是在远程主机上定义的一个命令脚本。具体在哪里定义稍后介绍。为什么中间加一个</span><span>”!”</span><span>，这个是</span><span>nagios</span><span>特有的形式，无需关心。下面需要到远程主机上去定义上面用到的脚本了。</span><span></span></p> <p><span>在远程主机上编辑</span><i><span>/usr/local/nagios/etc/nrpe.cfg </span></i><span>文件</span><span></span></p> <p><i><span>vim <span> </span>/usr/local/nagios/etc/nrpe.cfg </span></i><span>(client</span><span>上</span><span>)</span></p> <p><span>把</span><span>”</span><span>command[check_hda1]”</span><span>那行改成：</span><span></span></p> <p><span>command[check_hda1]=/usr/local/nagios/libexec/check_disk -w 20% -c 10% -p /dev/hda1</span></p> <p><span>然后再增加一行：</span><span></span></p> <p><span>command[check_hda2]=/usr/local/nagios/libexec/check_disk -w 20% -c 10% -p /dev/hda2</span></p> <p><span>// </span><span>这里的</span><span>check_hda1 </span><span>和</span><span> check_hda2 </span><span>都是自定义的，和</span><span>server</span><span>端的定义的</span><span>service</span><span>中的</span><span>check_command</span><span>对应。也就是说，如果在</span><span>server</span><span>端定义了一个</span><span>service</span><span>（通过</span><span>nrpe</span><span>方式）那么必须要在客户端上的</span><span>nrpe.cfg</span><span>中定义相应的脚本。保存这个文件后，需要重新启动一下</span><span>nrpe</span><span>服务。</span><span></span></p> <p><i><span>killall nrpe ; /usr/local/nagios/bin/nrpe -c /usr/local/nagios/etc/nrpe.cfg -d </span></i><span>（</span><span>client</span><span>上）</span><span></span></p> <p><span></span></p><p> </p> <p><span>3. </span><span>重启</span><span>nagios</span><span>服务</span><span></span></p> <p><span>修改了配置需要重启服务才能使添加的监控主机生效。</span><span></span></p> <p><i><span>/etc/init.d/nagios<span>  </span>restart<span>  </span></span></i><span>（</span><span>server</span><span>上）</span><span></span></p> <p><span>此时再到</span><span>web</span><span>页面去观察是否多了一台</span><span>10.0.4.56 </span></p> <p><span></span></p><p> </p> <p><span>【<b>在</b></span><b><span>nagios</span></b><b><span>客户端上自定义监控脚本</span></b><span>】</span><span></span></p> <p><span>在开始，笔者就讲过，我们可以自定义写监控脚步，从上面的例子中也可以看到监控磁盘状态时，是根据磁盘分区来监控的。这样不免有些麻烦，因为每台主机的磁盘分区状况都不一样（一样还好），而且有多少个分区就需要定义多少个命令。所以笔者就自定义写一个</span><span>shell</span><span>脚本来监控所有的磁盘分区：</span><span></span></p> <p><span>1. </span><span>在客户端上创建脚本</span><i><span>/usr/local/nagios/libexec/check_disk.sh</span></i><span></span></p> <p><i><span>vim <span> </span>/usr/local/nagios/libexec/check_disk.sh </span></i><span>写入如下内容：</span><span>(client</span><span>上</span><span>)<i></i></span></p><p><i></i></p><i></i> <p><span>#!/bin/bash</span></p> <p><span>row=`df -h -P|wc -l`</span></p> <p><span>status=0</span></p> <p><span>for i in `seq 2 $row`</span></p> <p><span>do</span></p> <p><span><span>        </span>spare=`df -h -P|sed -n "$i"p|awk ''`</span></p> <p><span><span>        </span>use_percentage=`df -h -P|sed -n "$i"p|sed -n "s/\%//"p|awk ''`</span></p> <p><span><span>        </span>spare_percentage=`expr 100 - $use_percentage`</span></p> <p><span><span>     </span><span>   </span>partition_name=`df -h -P|sed -n "$i"p|awk ''`</span></p> <p><span><span>        </span>if [ "$spare_percentage" -lt "3"<span>  </span>];then</span></p> <p><span><span>                </span>echo -n "$partition_name CRITICAL $% $spare<span>  </span>"</span></p> <p><span><span>                </span>status[$i]=2</span></p> <p><span><span>        </span>elif [ "$spare_percentage" -lt "5" ];then</span></p> <p><span><span>                </span>echo -n<span>  </span>"$partition_name WARNING! $% $spare<span>  </span>"</span></p> <p><span><span>                </span>status[$i]=1</span></p> <p><span><span>        </span>else</span></p> <p><span><span>                </span>echo -n<span>  </span>"$partition_name OK $% $spare<span>  </span>"</span></p> <p><span><span>                </span>status[$i]=0</span></p> <p><span><span>        </span>fi</span></p> <p><span>done</span></p> <p><span>zhuangtai=0</span></p> <p><span>for j in `seq 2 $row`</span></p> <p><span>do</span></p> <p><span><span>        </span>if [ "$" -gt "$zhuangtai"<span>  </span>];then</span></p> <p><span><span>                </span>zhuangtai=$</span></p> <p><span><span>        </span>fi</span></p> <p><span>done</span></p> <p><span>exit $zhuangtai</span></p> <p><span>2. </span><span>保存后，修改该脚本的权限</span><span></span></p> <p><i><span>chmod +x <span> </span>/usr/local/nagios/libexec/check_disk.sh </span></i><span>（</span><span>client</span><span>上）</span><span></span></p> <p><span>3. </span><span>然后编辑</span><span>/usr/local/nagios/etc/nrpe.cfg</span><span>文件</span><span></span></p> <p><i><span>vim /usr/local/nagios/etc/nrpe.cfg <span> </span></span></i><span># </span><span>加入一行：（</span><span>client</span><span>上）</span><span></span></p> <p><span>command[check_disk]=/usr/local/nagios/libexec/check_disk.sh</span></p> <p><span>保存，重启</span><span>nrpe</span><span>服务</span><span></span></p> <p><i><span>killall nrpe ; /usr/local/nagios/bin/nrpe -c /usr/local/nagios/etc/nrpe.cfg -d </span></i><span>（</span><span>client</span><span>上）</span><span></span></p> <p><span>4. </span><span>检测刚才的脚本是否正常运行的方法是，到</span><span>server</span><span>端执行如下命令：</span><span></span></p> <p><i><span>/usr/local/nagios/libexec/check_nrpe -H 10.0.4.56 -c check_disk</span></i><span>（</span><span>server</span><span>上）</span><span></span></p> <p><span>如果正常的话，会输出一行磁盘检测的数据，否则可能会报错。</span><span></span></p> <p><span>5. </span><span>到</span><span>server</span><span>上添加相应的</span><span>service</span></p> <p><i><span>cd<span>   </span>/usr/local/nagios/etc/services<span>  </span></span></i><span>（</span><span>server</span><span>上）</span><span></span></p> <p><i><span>vim<span>  </span>10.0.4.56.cfg<span>   </span></span></i><span># </span><span>加入如下内容：</span><span></span></p> <p><span>define service{</span></p> <p><span><span>        </span>use<span>     </span>generic-service</span></p> <p><span><span>        </span>host_name<span>       </span>10.0.4.56</span></p> <p><span><span>        </span>service_description<span>     </span>check_disk</span></p> <p><span><span>        </span>check_command<span>           </span>check_nrpe!check_disk</span></p> <p><span><span>        </span>max_check_attempts 5</span></p> <p><span><span>        </span>normal_check_interval 1</span></p> <p><span>}</span></p> <p><span>6. </span><span>重启</span><span>nagios</span><span>服务</span><span></span></p> <p><i><span>/etc/init.d/nagios restart<span>   </span></span></i><span>（</span><span>server</span><span>上）</span><span></span></p> <p><span></span></p><p> </p> <p><span>【<b>配置</b></span><b><span>nagios</span></b><b><span>报警邮件</span></b><span>】</span><span></span></p> <p><span>现在</span><span>139</span><span>邮箱有顺便发短信的功能，所以当有报警时，只需发送到你的</span><span>139</span><span>邮箱你就同样会收到一条报警短信。这样做的优势就是不用再去买短信网关了，节省了很大一笔钱。</span><span></span></p> <p><i><span>vim /usr/local/nagios/etc/objects/contacts.cfg</span></i></p><p><i></i></p><i></i> <p><span>把</span><span>”</span><span>email<span>       </span><span> </span><span> </span>nagios@localhost”<span>  </span></span><span>修改成</span><span> <span>“email<span>   </span></span></span><span>你的</span><span>139</span><span>邮箱</span><span>”</span></p> <p><i><span>vim /usr/local/nagios/etc/objects/templates.cfg</span></i></p><p><i></i></p><i></i> <p><span>找到：</span><span></span></p> <p><span>define service{</span></p> <p><span><span>        </span>name<span>                            </span>generic-service</span></p> <p><span>之所以看这一段，是因为在上面添加的</span><i><span>10.0.4.56.cfg </span></i><span>定义了很多</span><span>generic-service</span><span>所以要关注这段的配置。</span><span></span></p> <p><span>define service{</span></p> <p><span>name<span>     </span>generic-service<span>                 </span></span></p> <p><span>active_checks_enabled<span>     </span><span>     </span>1<span>                              </span></span></p> <p><span>passive_checks_enabled<span>          </span>1<span>                       </span></span></p> <p><span>parallelize_check<span>               </span>1<span>                       </span></span></p> <p><span>obsess_over_service<span>             </span>1<span>               </span><span>               </span></span></p> <p><span>check_freshness<span>                 </span>0<span>                      </span></span></p> <p><span>notifications_enabled<span>           </span>1<span>                              </span></span></p> <p><span>event_handler_enabled<span>           </span>1<span>                       </span></span></p> <p><span>flap_detection_enabled<span>          </span>1<span>                       </span></span></p> <p><span>failure_prediction_enabled<span>      </span>1<span>                       </span></span></p> <p><span>process_perf_data<span>               </span>1<span>                       </span></span></p> <p><span>retain_status_information <span>       </span>1<span>                               </span></span></p> <p><span>retain_nonstatus_information<span>    </span>1<span>                       </span></span></p> <p><span>is_volatile<span>              </span><span>       </span>0<span>                       </span></span></p> <p><span>check_period<span>            </span><span>        </span>24x7<span>         </span></span></p> <p><span>max_check_attempts<span>              </span>3<span>                      </span></span></p> <p><span>normal_check_interval<span>           </span>10<span>                      </span></span></p> <p><span>retry_check_interval<span>            </span>2<span>                       </span></span></p> <p><span>ontact_groups<span>                  </span>admins<span>                  </span></span></p> <p><span>notification_options<span>            </span>w,u,c,r<span>                 </span></span></p> <p><span>notification_interval<span>           </span>60<span>                      </span></span></p> <p><span>notification_period<span>             </span>24x7<span>                    </span></span></p> <p><span>register<span>                        </span>0<span>    </span><span>                  </span></span></p> <p><span>}</span></p> <p><span>其中有几个参数需要你注意：</span><span></span></p> <p><span>notifications_enabled : </span><span>是否开启提醒功能。</span><span>1</span><span>为开启，</span><span>0</span><span>为禁用。一般，这个选项会在主配置文件（</span><span>nagios.cfg</span><span>）中定义，效果相同。</span><span></span></p> <p><span>notification_interval: </span><span>重复发送提醒信息的最短间隔时间。默认间隔时间是</span><span>60</span><span>分钟。如果这个值设置为</span><span>0</span><span>，将不会发送重复提醒。</span><span></span></p> <p><span>notification_period: </span><span>发送提醒的时间段。非常重要的主机（服务）我定义为</span><span>7</span><span>×</span><span>24</span><span>，一般的主机（服务）就定义为上班时间。如果不在定义的时间段内，无论什么问题发生，都不会发送提醒。</span><span></span></p> <p><span>notification_options: </span><span>这个参数定义了发送提醒包括的情况：</span><span>d = </span><span>状态为</span><span>DOWN, u = </span><span>状态为</span><span>UNREACHABLE , r = </span><span>状态恢复为</span><span>OK ,<span>  </span>f = flapping</span><span>。，</span><span>n=</span><span>不发送提醒。</span><span></span></p> <p><span>要想正确发送邮件，上面的参数得配置合理才行。</span><span></span></p> 
